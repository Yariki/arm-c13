///////////////////////////////////////////////////////////
//  ARMGridViewModelBase.cs
//  Implementation of the Class ARMGridViewModelBase
//  Generated by Enterprise Architect
//  Created on:      30-Mar-2014 8:12:16 PM
///////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using ARM.Core.Enums;
using ARM.Core.Interfaces;
using ARM.Core.Interfaces.Data;
using ARM.Core.Service;
using ARM.Data.Layer.Interfaces;
using ARM.Infrastructure.Events;
using ARM.Infrastructure.Events.EventPayload;
using ARM.Infrastructure.Interfaces.Grid;
using Microsoft.Practices.Prism.Events;
using Microsoft.Practices.Prism.Regions;
using Microsoft.Practices.Unity;

namespace ARM.Infrastructure.MVVM
{
    /// <summary>
    /// Класс для представлення даних у сітці. 
    /// Загальний клас, якому передається тип моделі даних з якою він працює.
    /// </summary>
    /// <typeparam name="T">Тип моделі даних.</typeparam>
    public abstract class ARMGridViewModelBase<T> : ARMWorkspaceViewModelBase, IARMGridViewModel<T> where T : IARMModel
    {
        private IBll<T> _bll = null;

        /// <summary>
        /// Ініціалізує новий екземпляр класу <see cref="ARMGridViewModelBase{T}"/>.
        /// </summary>
        /// <param name="regionManager">Менеджер регіонів.</param>
        /// <param name="unityContainer">Контейнер IoC.</param>
        /// <param name="eventAggregator">Агарегатор подій.</param>
        /// <param name="view">The view.</param>
        protected ARMGridViewModelBase(IRegionManager regionManager, IUnityContainer unityContainer, IEventAggregator eventAggregator, IARMGridView view)
            : base(regionManager, unityContainer, eventAggregator, view)
        {
            Toolbox = UnityContainer.Resolve<IARMToolboxViewModel>();
            Toolbox.SetActions(OnToolboxExecute, OnToolboxCanExecute);
            Toolbox.InitializeCommands();
            Init();
        }

        /// <summary>
        /// Повертає дані для сітки.
        /// </summary>
        public IEnumerable<T> DataSource
        {
            get;
            private set;
        }

        /// <summary>
        /// Виконання команди з панелі інструментів.
        /// </summary>
        /// <param name="cmdType">Тип команди.</param>
        public void DoCommand(ToolbarCommand cmdType)
        {
        }

        /// <summary>
        /// Панель інтрументів.
        /// </summary>
        public IARMToolboxViewModel Toolbox
        {
            get;
            private set;
        }

        /// <summary>
        /// Повертає тип моделі даних, з яким працює сітка.
        /// </summary>
        public Type EntityType
        {
            get { return typeof(T); }
        }

        /// <summary>
        /// Вибраний запис у сітці.
        /// </summary>
        public T SelectedEntity { get; set; }

        #region [protected]

        /// <summary>
        /// Звільняє некеровані і - можливо - керовані ресурси.
        /// </summary>
        /// <param name="disposing"><c>true</c> щоб звільнити керовані і некеровані ресурси; <c>false</c> щоб звільнити тільки некеровані ресурси.</param>
        protected override void Dispose(bool disposing)
        {
            base.Dispose(disposing);
            if (!Disposed)
            {
                if (disposing)
                {
                    if (_bll != null)
                        _bll.Dispose();
                    DataSource = null;
                    EventAggregator.GetEvent<ARMSyncEvent>().Unsubscribe(OnSyncEvent);
                }
            }
        }

        /// <summary>
        /// Викликається, коли потрібно оновити пов'язані об'єкти.
        /// </summary>
        protected virtual void UpdateRelatedSource()
        {
        }

        #endregion [protected]

        #region [toolbox commands]

        /// <summary>
        /// Викликається при виборі команди на панелі урпавління.
        /// </summary>
        /// <param name="cmd">Команда.</param>
        private void OnToolboxExecute(ToolbarCommand cmd)
        {
            var processEvent = EventAggregator.GetEvent<ARMEntityProcessEvent>();
            switch (cmd)
            {
                case ToolbarCommand.Add:
                    processEvent.Publish(new ARMProcessEntityEventPayload(ARMModelsPropertyCache.Instance.GetMetadataByType(typeof(T)), ViewMode.Add, Guid.Empty));
                    break;

                case ToolbarCommand.Edit:
                    if (SelectedEntity != null)
                        processEvent.Publish(new ARMProcessEntityEventPayload(ARMModelsPropertyCache.Instance.GetMetadataByType(typeof(T)), ViewMode.Edit, SelectedEntity.Id));
                    break;

                case ToolbarCommand.Delete:
                    if (SelectedEntity != null)
                        DeleteEntity(SelectedEntity);
                    break;
            }
        }

        /// <summary>
        /// Визначає, яи доступний певна команда.
        /// </summary>
        /// <param name="cmd">Команда.</param>
        /// <returns></returns>
        private bool OnToolboxCanExecute(ToolbarCommand cmd)
        {
            return true;
        }

        #endregion [toolbox commands]

        #region [private]

        /// <summary>
        /// Ініціалізує цей екземпляр.
        /// </summary>
        private void Init()
        {
            _bll = UnityContainer.Resolve<IBll<T>>();
            if (_bll != null)
            {
                DataSource = _bll.GetAll().ToList();
                OnPropertyChanged(() => DataSource);
            }
            EventAggregator.GetEvent<ARMSyncEvent>().Subscribe(OnSyncEvent);
        }

        /// <summary>
        /// Викликається при синхронізації ресурсів.
        /// </summary>
        /// <param name="syncPayload">Аргументи.</param>
        private void OnSyncEvent(ARMSyncEventPayload syncPayload)
        {
            if (syncPayload == null || _bll == null)
                return;
            var metadata = ARMModelsPropertyCache.Instance.GetMetadataByType(typeof(T));
            if (metadata != syncPayload.Metadata)
                return;
            UpdateSource();
        }

        /// <summary>
        /// Оновлення даних.
        /// </summary>
        private void UpdateSource()
        {
            DataSource = null;
            _bll.Refresh();
            DataSource = _bll.GetAll().ToList();
            OnPropertyChanged(() => DataSource);
            UpdateRelatedSource();
        }

        /// <summary>
        /// Видалення запису з БД.
        /// </summary>
        /// <param name="entity">Запис.</param>
        private void DeleteEntity(T entity)
        {
            if (_bll == null)
                return;
            _bll.Delete(entity);
            _bll.Save();
            UpdateSource();
        }

        #endregion [private]
    }//end ARMGridViewModelBase
}//end namespace MVVM