///////////////////////////////////////////////////////////
//  ARMMainWorkspaceViewModel.cs
//  Implementation of the Class ARMMainWorkspaceViewModel
//  Generated by Enterprise Architect
//  Created on:      02-Apr-2014 1:17:47 AM
///////////////////////////////////////////////////////////

using System;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Threading;
using System.Windows.Controls;
using ARM.Core.Enums;
using ARM.Core.Interfaces;
using ARM.Core.MVVM;
using ARM.Data.Models;
using ARM.Infrastructure.Events;
using ARM.Infrastructure.Events.EventPayload;
using ARM.Module.Enums;
using ARM.Module.Interfaces;
using ARM.Module.Interfaces.References.ViewModel;
using ARM.Module.Interfaces.View;
using Microsoft.Practices.Prism.Events;
using Microsoft.Practices.Prism.Regions;
using Microsoft.Practices.Unity;
using Xceed.Wpf.Toolkit;

namespace ARM.Module.ViewModel.Main
{
    public class ARMMainWorkspaceViewModel : ARMViewModelBase, IARMMainWorkspaceViewModel
    {
        private readonly IUnityContainer _unityContainer;
        private readonly IEventAggregator _eventAggregator;

        #region [needs]

        private SubscriptionToken _tokenAdd;
        private SubscriptionToken _tokenEdit;
        private SubscriptionToken _tokenView;

        #endregion


        public ARMMainWorkspaceViewModel(IUnityContainer unityContainer, IEventAggregator eventAggregator, IARMMainWorkspaceView workspaceView)
            : base(workspaceView)
        {
            Items = new ObservableCollection<IARMWorkspaceViewModel>();
            _unityContainer = unityContainer;
            _eventAggregator = eventAggregator;
            Menu = _unityContainer.Resolve<IARMMainMenuViewModel>();
            Toolbox = _unityContainer.Resolve<IARMMainToolboxViewModel>();
            StatusBar = _unityContainer.Resolve<IARMMainStatusBarViewModel>();
            Menu.SetActions(OnMenuExecute, OnMenuCanExecute);
            Menu.InitializeCommands();
            InitEventAggregator();
        }

        private void InitEventAggregator()
        {
            if (_eventAggregator == null)
                return;
            var addEvent = _eventAggregator.GetEvent<ARMEntityAddEvent>();
            if (addEvent != null)
            {
                _tokenAdd = addEvent.Subscribe(OnAddEntity);
            }

            var editEvent = _eventAggregator.GetEvent<ARMEntityEditEvent>();
            if (editEvent != null)
            {
                _tokenEdit = editEvent.Subscribe(OnEditEntity);
            }

            var viewEvent = _eventAggregator.GetEvent<ARMEntityViewEvent>();
            if (viewEvent != null)
            {
                _tokenView = viewEvent.Subscribe(OnViewEntity);
            }
        }

        public IARMView MenuView
        {
            get { return Menu.View; }
        }

        public IARMView ToolboxView
        {
            get { return Toolbox.View; }
        }

        public IARMView StatusBarView
        {
            get { return StatusBar.View; }
        }

        public IARMMainMenuViewModel Menu { get; private set; }

        public IARMMainToolboxViewModel Toolbox { get; private set; }

        public IARMMainStatusBarViewModel StatusBar { get; private set; }
        public event EventHandler Close;

        public void OnClosing(CancelEventArgs arg)
        {

        }

        public ObservableCollection<IARMWorkspaceViewModel> Items { get; private set; }

        public IARMWorkspaceViewModel CurrentWorkspace { get; set; }

        #region [private]

        #region [menu]

        private void OnMenuExecute(eARMMainMenuCommand cmd)
        {
            switch (cmd)
            {
                case eARMMainMenuCommand.Exit:
                    if (Close != null)
                        Close(this, EventArgs.Empty);
                    break;
                case eARMMainMenuCommand.ReferenceUniversity:
                    Items.Add(_unityContainer.Resolve<IARMGridViewModel<University>>());
                    break;
                case eARMMainMenuCommand.ReferenceStaff:
                    Items.Add(_unityContainer.Resolve<IARMGridViewModel<Staff>>());
                    break;
            }
        }

        private bool OnMenuCanExecute(eARMMainMenuCommand cmd)
        {
            return true;
        }

        #endregion

        #region [global event add, edit, view]

        private void OnAddEntity(ARMAddEventPayload obj)
        {
            if (obj == null)
                return;
            switch (obj.Metadata)
            {
                case eARMMetadata.University:
                    var viewModel = _unityContainer.Resolve<IARMUniversityDataViewModel>();
                    if (viewModel != null)
                    {
                        viewModel.SetBusinessObject(new University(), obj.Mode);
                        Items.Add(viewModel);
                    }
                    break;
            }
        }

        private void OnEditEntity(ARMEditEventPayload obj)
        {

        }

        private void OnViewEntity(ARMViewPayload obj)
        {

        }

        #endregion

        #endregion



    } //end ARMMainWorkspaceViewModel
} //end namespace Main